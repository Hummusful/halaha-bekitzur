<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>הלאה בקיצור - Music News</title>
  <style>
   * { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
  min-height: 100vh;
  color: #ffffff;
  line-height: 1.6;
}

.container { max-width: 900px; margin: 0 auto; padding: 20px; }

.header { text-align: center; margin-bottom: 24px; padding: 20px 0; }

.site-title {
  font-size: 2.6rem; font-weight: 900; letter-spacing: -1px; margin-bottom: 8px;
  background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
  background-size: 300% 300%;
  -webkit-background-clip: text; background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: gradientShift 3s ease-in-out infinite;
}

.subtitle { font-size: 1rem; color: #a0a0a0; font-weight: 300; }

@keyframes gradientShift { 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }

/* Toolbar */
.toolbar {
  display: flex; gap: 10px; align-items: center; justify-content: center;
  margin: 12px 0 8px;
  flex-wrap: wrap;
}
.btn {
  border: 1px solid rgba(255,255,255,0.15);
  background: rgba(255,255,255,0.06);
  color: #fff; padding: 8px 14px; border-radius: 999px;
  font-size: 0.9rem; cursor: pointer; transition: all .2s ease;
  backdrop-filter: blur(6px);
}
.btn:hover { transform: translateY(-1px); border-color: rgba(78,205,196,0.5); }
.btn.active { border-color: rgba(78,205,196,0.8); box-shadow: 0 0 0 2px rgba(78,205,196,0.25) inset; }

.news-feed { margin-top: 14px; }

.news-item {
  background: rgba(

  </style>
</head>
<body>
  <div class="container">
    <header class="header" role="banner">
      <h1 class="site-title">הלאה בקיצור</h1>
      <p class="subtitle">Your Personal Music News Feed</p>
    </header>

    <div class="toolbar" role="toolbar" aria-label="News filters">
      <button class="btn active" data-filter="all" aria-pressed="true">הכול</button>
      <button class="btn" data-filter="HE" aria-pressed="false">ישראלי</button>
      <button class="btn" data-filter="EN" aria-pressed="false">בינלאומי</button>
    </div>

    <div class="news-feed" id="newsFeed" role="feed" aria-busy="true"></div>
  </div>

  <script defer>
  const WORKER_ENDPOINT = "https://music-agrragator.dustrial.workers.dev/";
  
    // חסימה מינימלית (רק מה שביקשת)
  const BLOCKED_SOURCES = ["al jazeera"];
  const BLOCKED_DOMAINS = ["aljazeera.com"];

  
  let currentFilter = "all"; // all | HE | EN

  function isAllowed(item) {
    const src = (item.source || "").toLowerCase();
    const host = (() => { try { return new URL(item.link).hostname.replace(/^www\./,""); } catch { return ""; } })();
    return !BLOCKED_SOURCES.some(b => src.includes(b)) &&
           !BLOCKED_DOMAINS.some(d => host.endsWith(d));
  }

  // --- שלב 1: מושכים ומציגים RAW (לראות מיד חדשות על המסך) ---
  async function fetchNews() {
    const res = await fetch(WORKER_ENDPOINT, { headers: { accept: "application/json" } });
    if (!res.ok) throw new Error(`Aggregator returned ${res.status}`);
    const data = await res.json();
    console.log("RAW from worker:", data.length, data.slice(0,3));
    if (!Array.isArray(data)) throw new Error("Invalid aggregator response");
    return data.filter(isAllowed);
  }

  function renderRaw(items) {
    const feed = document.getElementById('newsFeed');
    feed.setAttribute('aria-busy','false');
    if (!items.length) {
      feed.innerHTML = `<div class="empty-state"><h3>לא נמצאו ידיעות כרגע</h3><p>נסה לרענן בעוד רגע</p></div>`;
      return;
    }
    feed.innerHTML = items.slice(0,30).map(card).join("");
  }

  function card(story) {
    return `
      <article class="news-item" role="article">
        <div class="news-header">
          <div class="news-meta">
            <span class="language-badge">${story.language || 'EN'}</span>
            <span class="source-tag">${story.source || ''}</span>
          </div>
          <div class="news-date" title="${new Date(story.date||Date.now()).toLocaleString()}">${formatDate(story.date)}</div>
        </div>
        <h2 class="news-title">
          <a href="${story.link}" target="_blank" rel="noopener noreferrer">${escapeHtml(story.headline || '')}</a>
        </h2>
        <p class="news-summary">${escapeHtml(story.summary || '')}</p>
      </article>`;
  }

  // --- שלב 2: מוסיפים איזון לפי מקור + פילטרים אחרי שמוצג RAW ---
  function groupAndBalance(items) {
    const groups = {};
    for (const it of items) (groups[it.source || 'Unknown'] ||= []).push(it);
    const balanced = [];
    for (const src of Object.keys(groups)) {
      const top3 = groups[src].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,3);
      balanced.push(...top3);
    }
    return balanced.sort((a,b)=>new Date(b.date)-new Date(a.date));
  }

  function applyFilter(items, lang) {
    if (lang === "all") return items;
    return items.filter(x => (x.language || "").toUpperCase() === lang.toUpperCase());
  }

  function renderBalanced(items) {
    const feed = document.getElementById('newsFeed');
    feed.setAttribute('aria-busy','false');
    if (!items.length) {
      feed.innerHTML = `<div class="empty-state"><h3>לא נמצאו ידיעות כרגע</h3><p>נסה לרענן בעוד רגע</p></div>`;
      return;
    }
    feed.innerHTML = items.map(card).join("");
  }

  function bindFilters(balanced) {
    document.querySelectorAll('.toolbar .btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentFilter = btn.dataset.filter || 'all';
        updateActiveButton();
        const filtered = applyFilter(balanced, currentFilter);
        console.log("Filter:", currentFilter, "→", filtered.length);
        renderBalanced(filtered);
      });
    });
    updateActiveButton();
  }

  function updateActiveButton() {
    document.querySelectorAll('.toolbar .btn').forEach(btn => {
      const active = btn.dataset.filter === currentFilter || (currentFilter==="all" && btn.dataset.filter==="all");
      btn.classList.toggle('active', active);
      btn.setAttribute('aria-pressed', String(active));
    });
  }

  function loading() {
    const feed = document.getElementById('newsFeed');
    feed.setAttribute('aria-busy','true');
    feed.innerHTML = `<div class="empty-state"><h3>טוען חדשות מוזיקה...</h3><p>האוצרות האחרונים מהמקורות המובילים</p></div>`;
  }

  function escapeHtml(str){return (str||"").replace(/[&<>"]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]))}
  function formatDate(dateString){
    const date = new Date(dateString||Date.now());
    const now  = new Date();
    const diffHours = Math.floor(Math.abs(now - date)/(1000*60*60));
    if (diffHours<1) return 'Just now';
    if (diffHours<24) return `${diffHours} hours ago`;
    const diffDays = Math.floor(diffHours/24);
    return diffDays===1 ? 'Yesterday' : `${diffDays} days ago`;
  }

  // INIT
  (async function init(){
    try{
      loading();
      const raw = await fetchNews();
      // הצג מיד RAW כדי לוודא שמופיע משהו בעמוד
      renderRaw(raw);
      console.log("After RAW render. Now balancing + filters…");
      // עכשיו איזון + פילטרים
      const balanced = groupAndBalance(raw);
      console.log("Balanced count:", balanced.length);
      bindFilters(balanced);
      // ברירת מחדל: הכל
      currentFilter = "all";
      updateActiveButton();
      renderBalanced(applyFilter(balanced, currentFilter));
    }catch(e){
      console.error(e);
      const feed = document.getElementById('newsFeed');
      feed.setAttribute('aria-busy','false');
      feed.innerHTML = `<div class="empty-state"><h3 class="error">אירעה שגיאה</h3><p>${escapeHtml(e.message||"שגיאה לא צפויה")}</p></div>`;
    }
  })();
</script>

</body>
</html>
