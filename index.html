<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>הלאה בקיצור - Music News</title>
  <style>
/* === CSS שלך ללא שינוי מהותי === */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%); min-height: 100vh; color: #ffffff; line-height: 1.6; }
.container { max-width: 1100px; margin: 0 auto; padding: 20px; }
.header { text-align: center; margin-bottom: 24px; padding: 20px 0; }
.site-title { font-size: 2.6rem; font-weight: 900; letter-spacing: -1px; margin-bottom: 8px;
  background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4); background-size: 300% 300%;
  -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; animation: gradientShift 4.8s ease-in-out infinite; }
.subtitle { font-size: 1rem; color: #a0a0a0; font-weight: 300; }
@keyframes gradientShift { 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }
.toolbar { display: flex; gap: 12px; align-items: center; justify-content: center; margin: 16px 0 10px; flex-wrap: wrap; }
.btn { border: 1px solid rgba(0,229,255,0.25); background: rgba(0,229,255,0.08); color: #fff; padding: 9px 16px; border-radius: 999px;
  font-size: 0.92rem; cursor: pointer; transition: all .2s ease; letter-spacing: .2px; backdrop-filter: blur(6px); }
.btn:hover { transform: translateY(-1px); box-shadow: 0 0 0 1px rgba(0,229,255,0.35), 0 2px 10px rgba(0,0,0,0.12); }
.btn.active { background: rgba(0,229,255,0.16); box-shadow: 0 0 0 2px rgba(0,229,255,0.22) inset; }
.news-feed { margin-top: 16px; }
.news-item { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); backdrop-filter: blur(15px);
  border-radius: 16px; padding: 26px 22px; margin-bottom: 18px; border: 1px solid rgba(255, 255, 255, 0.06);
  transition: border-color 0.25s ease, transform 0.25s ease; position: relative; overflow: hidden; }
.news-item:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.14); }
.news-item::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
  opacity: .55; transition: opacity 0.25s ease; border-top-left-radius: 16px; border-top-right-radius: 16px; }
.news-item:hover::before { opacity: .7; }
.news-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; flex-wrap: wrap;
  padding-bottom: 8px; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.06); }
.news-meta { display: flex; gap: 8px; align-items: center; font-size: 0.85rem; color: #a0a0a0; }
.language-badge { background: linear-gradient(45deg, #ff6b6b, #4ecdc4); color: #fff; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; opacity: .9; }
.source-tag { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255,255,255,0.12); padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; opacity: .85; }
.news-title { font-size: 1.28rem; font-weight: 800; margin-bottom: 6px; line-height: 1.42; letter-spacing: .1px; }
.news-title a { color: #fff; text-decoration: none; transition: color 0.2s ease, border-color .2s ease, text-shadow .2s ease; border-bottom: 2px solid transparent; }
.news-title a:hover { color: #4ecdc4; border-bottom-color: rgba(0,229,255,0.45); text-shadow: none; }
.news-summary { color: #e8e8e8; line-height: 1.75; margin-top: 8px; margin-bottom: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); font-size: 1.02rem; }
.news-date { color: #9aa3b2; font-size: 0.85rem; white-space: nowrap; }
.empty-state { text-align: center; color: #a0a0a0; padding: 50px 16px; }
.empty-state h3 { font-size: 1.35rem; margin-bottom: 8px; color: #4ecdc4; }
.error { color: #ff9c9c; }
@media (max-width: 768px) { .container { padding: 15px; } .site-title { font-size: 2.1rem; } .news-item { padding: 20px 18px; } .news-header { flex-direction: column; align-items: flex-start; } }
@media (min-width: 1024px) { .news-feed { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; } .news-item { margin: 0; } }
@media (prefers-reduced-motion: reduce) { .site-title { animation: none; } .news-item, .btn { transition: none; } }
.news-item { content-visibility: auto; contain-intrinsic-size: 200px; }
:root { --cp-bg-1:#0f0f23; --cp-bg-2:#111827; --cp-neon-pink:#ff2d6f; --cp-neon-cyan:#00e5ff; --cp-edge:rgba(0,229,255,0.15); --cp-glow:0 0 18px rgba(0,229,255,0.25), 0 0 36px rgba(255,45,111,0.15); }
body { background: radial-gradient(1200px 600px at 70% -10%, rgba(255,45,111,0.06), transparent 50%), radial-gradient(800px 400px at 10% 110%, rgba(0,229,255,0.05), transparent 50%), linear-gradient(135deg, var(--cp-bg-1), var(--cp-bg-2)); }
.container { position: relative; border-radius: 24px; padding: 22px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)); box-shadow: 0 0 0 1px var(--cp-edge), 0 10px 30px rgba(0,0,0,0.35); }
.container::before { content:""; position:absolute; inset:-1px; border-radius:26px; background:linear-gradient(120deg, rgba(0,229,255,0.35), rgba(255,45,111,0.25), transparent 60%); filter: blur(16px); opacity:.35; pointer-events:none; }
@media (max-width:768px){ .container::before{ filter:blur(10px); opacity:.25; } }
.site-title { letter-spacing:.5px; text-shadow: var(--cp-glow); }
.language-badge { box-shadow:0 0 8px rgba(0,229,255,0.35); }
.source-tag { border:1px solid rgba(255,255,255,0.12); backdrop-filter: blur(6px); }
.news-title::before { content:"•"; margin-left:8px; color:var(--cp-neon-pink); text-shadow:0 0 8px rgba(255,45,111,0.5); font-weight:900; }
:where(a,button):focus-visible{ outline:none; box-shadow:0 0 0 2px #000, 0 0 0 4px var(--cp-neon-cyan), 0 0 16px var(--cp-neon-cyan); border-radius:10px; }
@media (forced-colors:active){ :where(a,button):focus-visible{ box-shadow:0 0 0 2px CanvasText; outline:2px solid CanvasText; } }
  </style>
</head>
<body>
  <div class="container">
    <header class="header" role="banner">
      <h1 class="site-title">הלאה בקיצור</h1>
      <p class="subtitle">Your Personal Music News Feed</p>
    </header>

    <div class="toolbar" role="toolbar" aria-label="News filters">
      <button class="btn active" data-filter="all" aria-pressed="true">הכול</button>
      <button class="btn" data-filter="HE" aria-pressed="false">ישראלי</button>
      <button class="btn" data-filter="EN" aria-pressed="false">בינלאומי</button>
      <button class="btn" id="onlySpotifyBtn" type="button">רק Spotify</button>
    </div>

    <div class="news-feed" id="newsFeed" role="feed" aria-live="polite" aria-busy="true"></div>
  </div>

  <script defer>
  /* ===================== CONFIG ===================== */
  const AGG_ENDPOINT = "https://music-agrragator.dustrial.workers.dev/";
  // ה-Worker החדש שמחזיר חודשיים אחורה (שנה את ה-URL ל-Worker שלך):
  const SPOTIFY_MONTHS_ENDPOINT = "https://spotify-new-releases.dustrial.workers.dev/api/spotify-months?market=IL&monthsBack=2&limit=50";
  const SPOTIFY_ENDPOINT_FALLBACK = "https://spotify-new-releases.dustrial.workers.dev/api/spotify-months?market=IL&monthsBack=2&limit=50";

  const MAX_ITEMS_TO_DISPLAY = 30;
  const MAX_ITEMS_PER_SOURCE = 3;
  const DEBUG = false; // שנה ל-true לבדיקות

  const BLOCKED_SOURCES = ["al jazeera"].map(s => s.toLowerCase());
  const BLOCKED_DOMAINS  = ["aljazeera.com"];
  let currentFilter = "all"; // all | HE | EN

  // ---------- helpers ----------
  function escapeHtml(str){return (str||"").replace(/[&<>"]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));}
  function escapeText(str){return escapeHtml(String(str||''));}
  function safeUrl(href){try{const u=new URL(href); return (u.protocol==='http:'||u.protocol==='https:')?u.href:null;}catch{ return null; }}
  function normLang(v){const s=String(v||'').trim().toLowerCase(); if(!s) return 'EN'; if(s.startsWith('he')) return 'HE'; if(s.startsWith('en')) return 'EN'; return s.toUpperCase();}
  function toDateSafe(v){const t=Date.parse(v); return isNaN(t)?new Date():new Date(t);}
  const rtf=new Intl.RelativeTimeFormat('he-IL',{numeric:'auto'});
  function formatDate(d){const date=toDateSafe(d),now=new Date(),ms=date-now,sec=Math.round(ms/1000),min=Math.round(sec/60),hr=Math.round(min/60),day=Math.round(hr/24);
    if(Math.abs(sec)<45) return rtf.format(0,'second'); if(Math.abs(min)<45) return rtf.format(min,'minute'); if(Math.abs(hr)<22) return rtf.format(hr,'hour'); return rtf.format(day,'day');}
  function isAllowed(item){const src=String(item.source||'').toLowerCase(); let host=''; try{host=new URL(item.link).hostname.replace(/^www\./,'').toLowerCase();}catch{} return !BLOCKED_SOURCES.some(b=>src.includes(b)) && !BLOCKED_DOMAINS.some(d=>host===d||host.endsWith('.'+d));}
  function getQueryFlag(name){return new URLSearchParams(location.search).get(name);}

  function albumsToNewsFromMonthsAPI(j){
    const arr = Array.isArray(j?.albums) ? j.albums : [];
    return arr.map(a => ({
      source: "Spotify",
      link: a.url || "#",
      headline: a.name || "",
      summary: Array.isArray(a.artists) ? a.artists.map(x=>x.name).join(Artist", ") + (a.total_tracks ? ` • ${a.total_tracks} Tracks` : "") : "",
      date: a.release_date || "",
      language: "EN"
    }));
  }

  function albumsToNewsFromSimpleAPI(j){
    // גיבוי אם רוצים להשתמש ב-worker הקיים שלך
    const raw = Array.isArray(j?.albums) ? j.albums : Array.isArray(j?.albums?.items) ? j.albums.items : [];
    return raw.map(a => ({
      source: "Spotify",
      link: a?.external_urls?.spotify || a?.url || "#",
      headline: a?.name || "",
      summary: Array.isArray(a?.artists) ? a.artists.map(x=>x.name).join(", ") + (a?.total_tracks ? ` • ${a.total_tracks} Tracks` : "") : "",
      date: a?.release_date || "",
      language: "EN"
    }));
  }

  /* ---------- fetchers ---------- */
  async function fetchAgg(timeoutMs=10000){
    const ctrl=new AbortController(); const to=setTimeout(()=>ctrl.abort(new Error('Timeout')),timeoutMs);
    try{
      const r = await fetch(AGG_ENDPOINT, { headers:{accept:"application/json"}, signal: ctrl.signal });
      if(!r.ok) throw new Error(`Agg ${r.status}`);
      const j = await r.json();
      const arr = Array.isArray(j)?j:(Array.isArray(j?.items)?j.items:[]);
      if (DEBUG) console.log("[Agg] items:", arr.length);
      return arr.filter(isAllowed);
    } finally { clearTimeout(to); }
  }

  async function fetchSpotifyMonths(timeoutMs=12000){
    const ctrl=new AbortController(); const to=setTimeout(()=>ctrl.abort(new Error('Timeout')),timeoutMs);
    try{
      const r = await fetch(SPOTIFY_MONTHS_ENDPOINT, { headers:{accept:"application/json"}, signal: ctrl.signal });
      if(!r.ok) throw new Error(`SpotifyMonths ${r.status}`);
      const j = await r.json();
      if (DEBUG) console.log("[SpotifyMonths] meta:", {market:j.market, monthsBack:j.monthsBack, count:j.count});
      return albumsToNewsFromMonthsAPI(j).filter(isAllowed);
    } finally { clearTimeout(to); }
  }

  async function fetchSpotifyFallback(timeoutMs=8000){
    const ctrl=new AbortController(); const to=setTimeout(()=>ctrl.abort(new Error('Timeout')),timeoutMs);
    try{
      const r = await fetch(SPOTIFY_ENDPOINT_FALLBACK, { headers:{accept:"application/json"}, signal: ctrl.signal });
      if(!r.ok) throw new Error(`SpotifyFallback ${r.status}`);
      const j = await r.json();
      const arr = albumsToNewsFromSimpleAPI(j).filter(isAllowed);
      if (DEBUG) console.log("[SpotifyFallback] items:", arr.length);
      return arr;
    } finally { clearTimeout(to); }
  }

  /* ---------- merge/dedup/sort ---------- */
  function mergeAndSort(arrays){
    const all = arrays.flat().filter(Boolean);
    const seen = new Set(); const out = [];
    for (const it of all){
      const url = safeUrl(it.link);
      const key = url || (it.source + "|" + (it.headline||"").trim());
      if (!key || seen.has(key)) continue;
      seen.add(key); out.push(it);
    }
    out.sort((a,b)=> toDateSafe(b.date) - toDateSafe(a.date));
    return out;
  }

  /* ---------- UI render (unchanged visuals) ---------- */
  function renderNews(items){
    const feed=document.getElementById('newsFeed'); feed.setAttribute('aria-busy','false');
    if(!items.length){ feed.innerHTML=`<div class="empty-state"><h3>לא נמצאו ידיעות כרגע</h3><p>נסה לרענן בעוד רגע</p></div>`; return; }
    feed.innerHTML = items.slice(0, MAX_ITEMS_TO_DISPLAY).map(card).join("");
  }

  function card(story){
    const lang=normLang(story.language); const src=escapeText(story.source||''); const url=safeUrl(story.link); const link=url||'#';
    const title=escapeHtml(story.headline||''); const summary=escapeHtml(story.summary||''); const dateAttr=toDateSafe(story.date||Date.now()).toLocaleString('he-IL');
    const anchorAttrs = url ? `href="${link}" target="_blank" rel="noopener noreferrer"` : `href="#" aria-disabled="true"`;
    return `
      <article class="news-item" role="article">
        <div class="news-header">
          <div class="news-meta">
            <span class="language-badge">${escapeText(lang)}</span>
            <span class="source-tag">${src}</span>
          </div>
          <div class="news-date" title="${escapeText(dateAttr)}">${formatDate(story.date)}</div>
        </div>
        <h2 class="news-title"><a ${anchorAttrs}>${title}</a></h2>
        <p class="news-summary">${summary}</p>
      </article>`;
  }

  /* ---------- balance & filters (as-is) ---------- */
  function groupAndBalance(items){
    const clean=items.filter(it=> safeUrl(it.link) && (it.headline||it.summary) && !isNaN(Date.parse(it.date)));
    const groups=new Map();
    for(const it of clean){ const k=(it.source||'Unknown').trim(); if(!groups.has(k)) groups.set(k,[]); groups.get(k).push(it); }
    const balanced=[];
    for(const arr of groups.values()){
      const topN = arr.slice().sort((a,b)=>toDateSafe(b.date)-toDateSafe(a.date)).slice(0, MAX_ITEMS_PER_SOURCE);
      balanced.push(...topN);
    }
    const seen=new Set(); const deduped=[];
    for(const it of balanced.sort((a,b)=>toDateSafe(b.date)-toDateSafe(a.date))){
      const k=safeUrl(it.link)||it.headline; if(!k||seen.has(k)) continue; seen.add(k); deduped.push(it);
    }
    return deduped;
  }
  function applyFilter(items, lang){ if(lang==="all") return items; const wanted=String(lang||'').toUpperCase(); return items.filter(x=>normLang(x.language)===wanted); }
  function bindFilters(balanced){
    document.querySelectorAll('.toolbar .btn[data-filter]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        currentFilter = btn.dataset.filter || 'all';
        updateActiveButton();
        const onlySpotify = getQueryFlag('only') === 'spotify';
        let list = applyFilter(balanced, currentFilter);
        if (onlySpotify) list = list.filter(x => x.source === 'Spotify');
        renderNews(list);
      });
    });
    updateActiveButton();
  }
  function updateActiveButton(){
    document.querySelectorAll('.toolbar .btn[data-filter]').forEach(btn=>{
      const active = btn.dataset.filter === currentFilter || (currentFilter==="all" && btn.dataset.filter==="all");
      btn.classList.toggle('active', active);
      btn.setAttribute('aria-pressed', String(active));
    });
  }
  function loading(){ const feed=document.getElementById('newsFeed'); feed.setAttribute('aria-busy','true');
    feed.innerHTML=`<div class="empty-state"><h3>טוען חדשות מוזיקה...</h3><p>האוצרות האחרונים מהמקורות המובילים</p></div>`; }

  // כפתור רק-Spotify → מוסיף ?only=spotify (ללא שינוי עיצוב)
  document.getElementById('onlySpotifyBtn').addEventListener('click', () => {
    const u = new URL(location.href);
    u.searchParams.set('only', 'spotify');
    location.href = u.toString();
  });

  // INIT
  (async function init(){
    try{
      loading();
      const onlySpotify = getQueryFlag('only') === 'spotify';

      if (onlySpotify) {
        // חודשיים אחורה, עד 50 פריטים מה-Worker החדש
        const sp = await fetchSpotifyMonths();
        renderNews(sp.slice(0, MAX_ITEMS_TO_DISPLAY));
        return;
      }

      // מצב רגיל: שני מקורות (AGG + fallback Spotify אם רוצים), ואז איזון ומסננים
      const [agg, spotFallback] = await Promise.allSettled([
        fetchAgg(),
        fetchSpotifyFallback().catch(()=>[])
      ]);
      const aggData = agg.status === "fulfilled" ? agg.value : [];
      const spData  = spotFallback.status === "fulfilled" ? spotFallback.value : [];

      const merged = mergeAndSort([aggData, spData]);
      const balanced = groupAndBalance(merged);
      bindFilters(balanced);
      renderNews(applyFilter(balanced, currentFilter));

      if (DEBUG) console.log("[Init] done");
    }catch(e){
      const feed=document.getElementById('newsFeed');
      feed.setAttribute('aria-busy','false');
      feed.innerHTML = `<div class="empty-state"><h3 class="error">אירעה שגיאה</h3><p>${escapeHtml(e.message||"שגיאה לא צפויה")}</p></div>`;
      console.error(e);
    }
  })();
  </script>
</body>
</html>
