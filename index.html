<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>קיצר - Music News</title>
  <link rel="icon" href="/favicon.ico">
  <style>
/* עיצוב כללי זהה לגרסה הקודמת */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#0f0f23 0%,#1a1a2e 50%,#16213e 100%);color:#fff;min-height:100vh}
.container{max-width:1100px;margin:0 auto;padding:20px}
.header{text-align:center;margin-bottom:24px;padding:20px 0}
.site-title{font-size:2.6rem;font-weight:900;letter-spacing:-1px;margin-bottom:8px;background:linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1,#96ceb4);background-size:300% 300%;-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;animation:gradientShift 4.8s ease-in-out infinite}
.subtitle{font-size:1rem;color:#a0a0a0;font-weight:300}
@keyframes gradientShift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
.toolbar{display:flex;gap:12px;align-items:center;justify-content:center;margin:16px 0 10px;flex-wrap:wrap}
.btn{border:1px solid rgba(0,229,255,0.25);background:rgba(0,229,255,0.08);color:#fff;padding:9px 16px;border-radius:999px;font-size:.92rem;cursor:pointer;transition:.2s}
.btn:hover{transform:translateY(-1px);box-shadow:0 0 0 1px rgba(0,229,255,0.35),0 2px 10px rgba(0,0,0,0.12)}
.btn.active{background:rgba(0,229,255,0.16);box-shadow:0 0 0 2px rgba(0,229,255,0.22) inset}
.news-feed{margin-top:16px}
.news-item{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:20px;margin-bottom:18px;transition:.2s}
.news-item:hover{border-color:rgba(255,255,255,0.12);transform:translateY(-2px)}
.news-title{font-size:1.2rem;font-weight:700;margin-bottom:6px}
.genre-tag{background:rgba(30,215,96,0.2);border:1px solid rgba(30,215,96,0.4);color:#1ed760;padding:3px 8px;border-radius:12px;font-size:.72rem;font-weight:600;margin-right:4px}
.spinner{width:40px;height:40px;border:4px solid rgba(255,255,255,.15);border-top-color:#4ecdc4;border-radius:50%;animation:spin .8s linear infinite;margin:20px auto}
@keyframes spin{to{transform:rotate(360deg)}}
.empty-state{text-align:center;color:#a0a0a0;padding:40px}
  </style>
</head>
<body>
  <div class="container" role="main">
    <header class="header" role="banner">
      <h1 class="site-title">קיצר</h1>
      <h2 class="subtitle">Dusty's Feed</h2>
    </header>

    <div class="toolbar">
      <button class="btn active" data-filter="all">הכול</button>
      <button class="btn" data-filter="HE">ישראלי</button>
      <button class="btn" data-filter="EN">בינלאומי</button>
      <button class="btn" id="onlySpotifyBtn">רק Spotify</button>
      <div class="mode-selector" id="modeSelector" style="display:none;">
        <label for="spotifyMode">כיסוי:</label>
        <select id="spotifyMode">
          <option value="curated">מומלצים</option>
          <option value="extended">מורחב</option>
        </select>
      </div>
    </div>

    <div class="news-feed" id="newsFeed" aria-live="polite"></div>
  </div>

<script>
const AGG_ENDPOINT="https://music-agrragator.dustrial.workers.dev/";
const SPOTIFY_RELEASES_ENDPOINT="https://spotify-new-releases.dustrial.workers.dev/api/spotify-releases";
const MAX_ITEMS_TO_DISPLAY=50;
let currentFilter="all"; let isSpotifyMode=false;

function toDateSafe(v){const t=Date.parse(v);return isNaN(t)?new Date():new Date(t);}
function formatDate(d){return toDateSafe(d).toLocaleDateString('he-IL');}
function escapeHtml(s){const div=document.createElement('div');div.textContent=s;return div.innerHTML;}
function normLang(v){const s=(v||'').toLowerCase();return s.startsWith('he')?'HE':'EN';}
function pickImage(images){return Array.isArray(images)&&images[0]?images[0].url:null;}
function safeUrl(h){try{const u=new URL(h);return u.href;}catch{return null;}}

// === FETCHES ===
async function fetchAgg(timeoutMs=10000){
  const ctrl=new AbortController();const to=setTimeout(()=>ctrl.abort(),timeoutMs);
  try{
    const r=await fetch(AGG_ENDPOINT,{signal:ctrl.signal});
    if(!r.ok)throw new Error(`Agg ${r.status}`);
    const j=await r.json();
    return Array.isArray(j)?j:(Array.isArray(j.items)?j.items:[]);
  }finally{clearTimeout(to);}
}

async function fetchSpotifyReleases(mode='curated',market='IL',monthsBack=2,timeoutMs=15000){
  const ctrl=new AbortController();const to=setTimeout(()=>ctrl.abort(),timeoutMs);
  const params=new URLSearchParams({market,monthsBack,mode});
  const url=`${SPOTIFY_RELEASES_ENDPOINT}?${params.toString()}`;
  try{
    const r=await fetch(url,{signal:ctrl.signal});
    if(!r.ok)throw new Error(`Spotify ${r.status}`);
    const j=await r.json();
    if(j.error)throw new Error(j.error);
    return albumsToNewsFromDetailedAPI(j);
  }finally{clearTimeout(to);}
}

// === HELPERS ===
function albumsToNewsFromDetailedAPI(j){
  return (j.albums||[]).map(a=>({
    source:"Spotify",
    link:a.url||null,
    headline:a.album_name||"",
    summary:(a.artists||[]).map(x=>x.name).join(", "),
    date:a.release_date,
    language:"EN",
    cover:pickImage(a.images),
    genres:a.genres||[a.primary_genre].filter(Boolean),
    meta:{label:a.label||"",tracks:a.total_tracks}
  }));
}
function groupAndBalance(items){
  const map=new Map();
  for(const it of items){const src=it.source||'Unknown';if(!map.has(src))map.set(src,[]);map.get(src).push(it);}
  const balanced=[];for(const arr of map.values())balanced.push(...arr.slice(0,3));
  return balanced.sort((a,b)=>toDateSafe(b.date)-toDateSafe(a.date));
}
function applyFilter(items,lang){if(lang==='all')return items;return items.filter(x=>normLang(x.language)===lang);}
function renderGenres(genres){if(!Array.isArray(genres)||!genres.length)return"";return `<div>${genres.slice(0,3).map(g=>`<span class="genre-tag">${escapeHtml(g)}</span>`).join('')}</div>`;}
function card(story){const link=safeUrl(story.link);return `<article class="news-item"><h2 class="news-title">${link?`<a href="${link}" target="_blank">${escapeHtml(story.headline)}</a>`:escapeHtml(story.headline)}</h2><p>${escapeHtml(story.summary||'')}</p>${renderGenres(story.genres)}<div>${formatDate(story.date)}</div></article>`;}
function showLoading(){document.getElementById('newsFeed').innerHTML=`<div class="empty-state"><div class="spinner"></div><h3>טוען חדשות...</h3></div>`;}
function showError(msg){document.getElementById('newsFeed').innerHTML=`<div class="empty-state"><h3>שגיאה</h3><p>${escapeHtml(msg)}</p><button onclick="location.reload()">נסה שוב</button></div>`;}
function renderNews(items){document.getElementById('newsFeed').innerHTML=items.slice(0,MAX_ITEMS_TO_DISPLAY).map(card).join('');}
function bindFilters(items){document.querySelectorAll('.toolbar .btn[data-filter]').forEach(btn=>btn.addEventListener('click',()=>{currentFilter=btn.dataset.filter;updateButtons();renderNews(applyFilter(items,currentFilter));}));}
function updateButtons(){document.querySelectorAll('.toolbar .btn[data-filter]').forEach(btn=>btn.classList.toggle('active',btn.dataset.filter===currentFilter));}

// === EVENTS ===
document.getElementById('onlySpotifyBtn')?.addEventListener('click',()=>{
  const u=new URL(location.href);
  if(u.searchParams.get('only')==='spotify'){u.searchParams.delete('only');u.searchParams.delete('mode');}
  else{u.searchParams.set('only','spotify');u.searchParams.set('mode','curated');}
  location.replace(u.toString());
});
document.getElementById('spotifyMode')?.addEventListener('change',e=>{
  const u=new URL(location.href);u.searchParams.set('mode',e.target.value);location.replace(u.toString());
});

// === INIT ===
(async function init(){
  try{
    const onlySpotify=new URLSearchParams(location.search).get('only')==='spotify';
    const mode=new URLSearchParams(location.search).get('mode')||'curated';
    showLoading();
    if(onlySpotify){
      document.getElementById('modeSelector').style.display='flex';
      const data=await fetchSpotifyReleases(mode);
      const limit=(mode==='extended')?100:MAX_ITEMS_TO_DISPLAY;
      renderNews(data.slice(0,limit));
    }else{
      const data=await fetchAgg();
      const balanced=groupAndBalance(data);
      bindFilters(balanced);
      renderNews(applyFilter(balanced,currentFilter));
    }
  }catch(e){showError(e.message||"שגיאה לא צפויה");console.error(e);}
})();
</script>
</body>
</html>
